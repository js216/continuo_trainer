// SPDX-License-Identifier: GPL-2.0-or-later

/**
 * @file theory.h
 * @brief Pure music theory routines.
 * @author Jakob Kastelic
 */

#ifndef THEORY_H
#define THEORY_H

#include <string>
#include <unordered_set>
#include <vector>

#define NOTES_OUT_OF_RANGE (-100)

enum midi_note {
   NOTES_C_1 = 0,
   NOTES_Cs_1,
   NOTES_D_1,
   NOTES_Ds_1,
   NOTES_E_1,
   NOTES_F_1,
   NOTES_Fs_1,
   NOTES_G_1,
   NOTES_Gs_1,
   NOTES_A_1,
   NOTES_As_1,
   NOTES_B_1,
   NOTES_C0,
   NOTES_Cs0,
   NOTES_D0,
   NOTES_Ds0,
   NOTES_E0,
   NOTES_F0,
   NOTES_Fs0,
   NOTES_G0,
   NOTES_Gs0,
   NOTES_A0,
   NOTES_As0,
   NOTES_B0,
   NOTES_C1,
   NOTES_Cs1,
   NOTES_D1,
   NOTES_Ds1,
   NOTES_E1,
   NOTES_F1,
   NOTES_Fs1,
   NOTES_G1,
   NOTES_Gs1,
   NOTES_A1,
   NOTES_As1,
   NOTES_B1,
   NOTES_C2,
   NOTES_Cs2,
   NOTES_D2,
   NOTES_Ds2,
   NOTES_E2,
   NOTES_F2,
   NOTES_Fs2,
   NOTES_G2,
   NOTES_Gs2,
   NOTES_A2,
   NOTES_As2,
   NOTES_B2,
   NOTES_C3,
   NOTES_Cs3,
   NOTES_D3,
   NOTES_Ds3,
   NOTES_E3,
   NOTES_F3,
   NOTES_Fs3,
   NOTES_G3,
   NOTES_Gs3,
   NOTES_A3,
   NOTES_As3,
   NOTES_B3,
   NOTES_C4,
   NOTES_Cs4,
   NOTES_D4,
   NOTES_Ds4,
   NOTES_E4,
   NOTES_F4,
   NOTES_Fs4,
   NOTES_G4,
   NOTES_Gs4,
   NOTES_A4,
   NOTES_As4,
   NOTES_B4,
   NOTES_C5,
   NOTES_Cs5,
   NOTES_D5,
   NOTES_Ds5,
   NOTES_E5,
   NOTES_F5,
   NOTES_Fs5,
   NOTES_G5,
   NOTES_Gs5,
   NOTES_A5,
   NOTES_As5,
   NOTES_B5,
   NOTES_C6,
   NOTES_Cs6,
   NOTES_D6,
   NOTES_Ds6,
   NOTES_E6,
   NOTES_F6,
   NOTES_Fs6,
   NOTES_G6,
   NOTES_Gs6,
   NOTES_A6,
   NOTES_As6,
   NOTES_B6,
   NOTES_C7,
   NOTES_Cs7,
   NOTES_D7,
   NOTES_Ds7,
   NOTES_E7,
   NOTES_F7,
   NOTES_Fs7,
   NOTES_G7,
   NOTES_Gs7,
   NOTES_A7,
   NOTES_As7,
   NOTES_B7,
   NOTES_C8,
   NOTES_Cs8,
   NOTES_D8,
   NOTES_Ds8,
   NOTES_E8,
   NOTES_F8,
   NOTES_Fs8,
   NOTES_G8,
   NOTES_Gs8,
   NOTES_A8,
   NOTES_As8,
   NOTES_B8,
   NOTES_C9,
   NOTES_Cs9,
   NOTES_D9,
   NOTES_Ds9,
   NOTES_E9,
   NOTES_F9,
   NOTES_Fs9,
   NOTES_G9,
   NOTES_Gs9,
   NOTES_A9,
   NOTES_As9,
   NOTES_B9,
   NOTES_NUM
};

enum note_name {
   NN_C_1,
   NN_Cs_1,
   NN_Db_1,
   NN_D_1,
   NN_Ds_1,
   NN_Eb_1,
   NN_E_1,
   NN_Fb_1,
   NN_Es_1,
   NN_F_1,
   NN_Fs_1,
   NN_Gb_1,
   NN_G_1,
   NN_Gs_1,
   NN_Ab_1,
   NN_A_1,
   NN_As_1,
   NN_Bb_1,
   NN_B_1,
   NN_Cb_1,
   NN_C0,
   NN_Cs0,
   NN_Db0,
   NN_D0,
   NN_Ds0,
   NN_Eb0,
   NN_E0,
   NN_Fb0,
   NN_Es0,
   NN_F0,
   NN_Fs0,
   NN_Gb0,
   NN_G0,
   NN_Gs0,
   NN_Ab0,
   NN_A0,
   NN_As0,
   NN_Bb0,
   NN_B0,
   NN_Cb0,
   NN_C1,
   NN_Cs1,
   NN_Db1,
   NN_D1,
   NN_Ds1,
   NN_Eb1,
   NN_E1,
   NN_Fb1,
   NN_Es1,
   NN_F1,
   NN_Fs1,
   NN_Gb1,
   NN_G1,
   NN_Gs1,
   NN_Ab1,
   NN_A1,
   NN_As1,
   NN_Bb1,
   NN_B1,
   NN_Cb1,
   NN_C2,
   NN_Cs2,
   NN_Db2,
   NN_D2,
   NN_Ds2,
   NN_Eb2,
   NN_E2,
   NN_Fb2,
   NN_Es2,
   NN_F2,
   NN_Fs2,
   NN_Gb2,
   NN_G2,
   NN_Gs2,
   NN_Ab2,
   NN_A2,
   NN_As2,
   NN_Bb2,
   NN_B2,
   NN_Cb2,
   NN_C3,
   NN_Cs3,
   NN_Db3,
   NN_D3,
   NN_Ds3,
   NN_Eb3,
   NN_E3,
   NN_Fb3,
   NN_Es3,
   NN_F3,
   NN_Fs3,
   NN_Gb3,
   NN_G3,
   NN_Gs3,
   NN_Ab3,
   NN_A3,
   NN_As3,
   NN_Bb3,
   NN_B3,
   NN_Cb3,
   NN_C4,
   NN_Cs4,
   NN_Db4,
   NN_D4,
   NN_Ds4,
   NN_Eb4,
   NN_E4,
   NN_Fb4,
   NN_Es4,
   NN_F4,
   NN_Fs4,
   NN_Gb4,
   NN_G4,
   NN_Gs4,
   NN_Ab4,
   NN_A4,
   NN_As4,
   NN_Bb4,
   NN_B4,
   NN_Cb4,
   NN_C5,
   NN_Cs5,
   NN_Db5,
   NN_D5,
   NN_Ds5,
   NN_Eb5,
   NN_E5,
   NN_Fb5,
   NN_Es5,
   NN_F5,
   NN_Fs5,
   NN_Gb5,
   NN_G5,
   NN_Gs5,
   NN_Ab5,
   NN_A5,
   NN_As5,
   NN_Bb5,
   NN_B5,
   NN_Cb5,
   NN_C6,
   NN_Cs6,
   NN_Db6,
   NN_D6,
   NN_Ds6,
   NN_Eb6,
   NN_E6,
   NN_Fb6,
   NN_Es6,
   NN_F6,
   NN_Fs6,
   NN_Gb6,
   NN_G6,
   NN_Gs6,
   NN_Ab6,
   NN_A6,
   NN_As6,
   NN_Bb6,
   NN_B6,
   NN_Cb6,
   NN_C7,
   NN_Cs7,
   NN_Db7,
   NN_D7,
   NN_Ds7,
   NN_Eb7,
   NN_E7,
   NN_Fb7,
   NN_Es7,
   NN_F7,
   NN_Fs7,
   NN_Gb7,
   NN_G7,
   NN_Gs7,
   NN_Ab7,
   NN_A7,
   NN_As7,
   NN_Bb7,
   NN_B7,
   NN_Cb7,
   NN_C8,
   NN_Cs8,
   NN_Db8,
   NN_D8,
   NN_Ds8,
   NN_Eb8,
   NN_E8,
   NN_Fb8,
   NN_Es8,
   NN_F8,
   NN_Fs8,
   NN_Gb8,
   NN_G8,
   NN_Gs8,
   NN_Ab8,
   NN_A8,
   NN_As8,
   NN_Bb8,
   NN_B8,
   NN_Cb8,
   NN_C9,
   NN_Cs9,
   NN_Db9,
   NN_D9,
   NN_Ds9,
   NN_Eb9,
   NN_E9,
   NN_Fb9,
   NN_Es9,
   NN_F9,
   NN_Fs9,
   NN_Gb9,
   NN_G9,
   NN_Gs9,
   NN_Ab9,
   NN_A9,
   NN_As9,
   NN_Bb9,
   NN_B9,
   NN_Cb9,
   NN_C10,
   NN_Cs10,
   NN_Db10,
   NN_D10,
   NN_Ds10,
   NN_Eb10,
   NN_E10,
   NN_Fb10,
   NN_Es10,
   NN_F10,
   NN_Fs10,
   NN_Gb10,
   NN_G10,
   NN_Gs10,
   NN_Ab10,
   NN_A10,
   NN_As10,
   NN_Bb10,
   NN_B10,
   NN_Cb10,
   NN_NUM
};

enum key_sig {
   KEY_SIG_0,
   KEY_SIG_1_SHARP,
   KEY_SIG_2_SHARP,
   KEY_SIG_3_SHARP,
   KEY_SIG_4_SHARP,
   KEY_SIG_5_SHARP,
   KEY_SIG_6_SHARP,
   KEY_SIG_7_SHARP,
   KEY_SIG_1_FLAT,
   KEY_SIG_2_FLAT,
   KEY_SIG_3_FLAT,
   KEY_SIG_4_FLAT,
   KEY_SIG_5_FLAT,
   KEY_SIG_6_FLAT,
   KEY_SIG_7_FLAT,
   KEY_NUM
};

enum accidental {
   ACC_NONE,
   ACC_SHARP,
   ACC_FLAT,
   ACC_NATURAL,
   ACC_SLASH,
   ACC_NUM
};

struct figure {
   int num;
   enum accidental acc;
};

struct column {
   std::unordered_set<enum midi_note> bass;
   std::vector<struct figure> figures;
   std::unordered_set<enum midi_note> answer;
   std::unordered_set<enum midi_note> good;
   std::unordered_set<enum midi_note> bad;
   std::unordered_set<enum midi_note> missed;
   double time;
};

// placement
int th_note_to_bass(const enum midi_note n, const enum key_sig k);
int th_note_to_treble(const enum midi_note n, const enum key_sig k);
enum note_name th_preferred_spelling(enum midi_note n, enum key_sig key);

// accidentals
enum accidental th_key_sig_accidental(enum key_sig key, enum midi_note n);
int th_key_sig_acc_count(enum key_sig key);

// judging
std::unordered_set<enum midi_note>
th_get_missed(const std::unordered_set<enum midi_note> &answer,
              const std::unordered_set<enum midi_note> &good);

// convert TO string
std::string th_key_sig_to_string(enum key_sig);
std::string th_midi_to_string(enum midi_note n);
std::string th_nn_to_string(const note_name nn);
std::string th_fig_to_string(const std::vector<figure> &figs);

// convert FROM string
key_sig th_parse_key(const std::string &token);
std::vector<figure> th_parse_figures_from_str(const std::string &token);
enum midi_note th_parse_midi_note(const std::string &token);

#endif /* THEORY_H */
